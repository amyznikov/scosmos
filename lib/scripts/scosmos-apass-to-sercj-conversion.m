#! /usr/bin/octave -qf

%
% Перевод Bj,Vj в фильтр 'Bc' используя пересечение serc-j/apass
% в линейной части характеристической кривой:
%   Bc = a0 + a1*Bj + a2*(Bj-Vj) = b0 + b1 * scosmos ;
% 
% Система переопределена; произвол снимается избавившись
% от свободных нуль-пункта и множителя и минимизируя дисперсию за
% цвет:
%   Bj = c0 + c1 * scosmos + c2*(Bj-Vj)
%
% Решение системы выполняется по звездам apass.
%
%



pkg load optim;

arg_list = argv ();

FLIST = {};
outname = '';
K = 3;
NPASS = 5;


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

function show_usage( stream )
  fprintf(stream, 'USAGE:\n');
  fprintf(stream, '  %s [-o {output-name}] [-K K] [-N NPASS] apass.sercj.dat ...\n', program_name());
end


function [minmag, maxmag] = get_cosmag_limits( plateid )

  persistent C = {
    [-25.50  -23.75] % 65537
    [-25.50  -23.75] % 65538
    [-25.50  -23.75] % 65539
    [-25.50  -23.70] % 65540
    [-25.50  -23.50] % 65541
    [-25.75  -24.00] % 65542
    [-25.75  -24.00] % 65543
    [-25.75  -24.00] % 65544
    [-25.50  -23.75] % 65545
    [-25.50  -23.75] % 65546
    [-25.50  -23.75] % 65547
    [-25.80  -24.20] % 65548
    [-25.50  -23.75] % 65549
    [-25.50  -23.70] % 65550
    [-26.00  -24.25] % 65551
    [-25.75  -24.00] % 65552
    [-25.50  -23.80] % 65553
    [-25.50  -23.75] % 65554
    [-25.50  -23.75] % 65555
    [-25.75  -23.85] % 65556
    [-25.50  -23.75] % 65557
    [-25.50  -23.50] % 65558
    [-25.50  -23.40] % 65559
    [-25.50  -23.40] % 65560
    [-25.50  -23.75] % 65561
    [-25.00  -23.50] % 65562
    [-25.50  -23.75] % 65563
    [-25.50  -23.75] % 65564
    [-25.50  -23.50] % 65565
    [-25.50  -23.75] % 65566
    [-25.50  -23.75] % 65567
    [-25.50  -23.40] % 65568
    [-25.50  -23.75] % 65569
    [-25.50  -23.50] % 65570
    [-26.00  -24.20] % 65571
    [-25.50  -23.75] % 65572
    [-25.50  -23.50] % 65573
    [-25.30  -23.20] % 65574
    [-25.75  -23.75] % 65575
    [-26.00  -24.00] % 65576
    [-25.40  -23.75] % 65577
    [-25.50  -23.50] % 65578
    [-26.00  -24.25] % 65579
    [-25.70  -23.60] % 65580
    [-25.50  -23.75] % 65581
    [-25.75  -24.00] % 65582
    [-25.70  -23.75] % 65583
    [-25.75  -24.00] % 65584
    [-25.50  -23.75] % 65585
    [-25.25  -23.25] % 65586
    [-26.00  -24.00] % 65587
    [-25.50  -23.75] % 65588
    [-25.50  -23.50] % 65589
    [-25.25  -23.25] % 65590
    [-25.50  -23.75] % 65591
    [-26.00  -24.00] % 65592
    [-25.50  -23.50] % 65593
    [-25.50  -23.50] % 65594
    [-25.45  -23.65] % 65595
    [-25.50  -23.50] % 65596
    [-25.00  -23.25] % 65597
    [-25.25  -23.50] % 65598
    [-25.25  -23.50] % 65599
    [-25.25  -23.50] % 65600
    [-25.30  -23.50] % 65601
    [-25.75  -23.75] % 65602
    [-25.60  -23.75] % 65603
    [-25.50  -23.50] % 65604
    [-25.50  -23.50] % 65605
    [-25.70  -24.15] % 65606
    [-25.50  -23.75] % 65607
    [-25.70  -23.65] % 65608
    [-25.50  -23.75] % 65609
    [-25.50  -23.75] % 65610
    [-25.50  -23.60] % 65611
    [-25.50  -23.75] % 65612
    [-25.50  -23.50] % 65613
    [-25.60  -23.70] % 65614
    [-25.50  -23.75] % 65615
    [-26.00  -24.25] % 65616
    [-25.50  -23.50] % 65617
    [-25.50  -23.25] % 65618
    [-25.50  -23.50] % 65619
    [-25.80  -24.00] % 65620
    [-26.00  -23.75] % 65621
    [-25.25  -23.50] % 65622
    [-26.25  -24.25] % 65623
    [-25.50  -23.75] % 65624
    [-25.50  -23.25] % 65625
    [-25.50  -23.25] % 65626
    [-26.25  -24.20] % 65627
    [-25.65  -23.50] % 65628
    [-25.50  -23.75] % 65629
    [-25.50  -23.75] % 65630
    [-25.75  -23.75] % 65631
    [-25.50  -23.75] % 65632

    [-25.50  -23.75] % 65633
    [-25.50  -23.75] % 65634
    [-25.50  -23.75] % 65635
    [-26.20  -23.50] % 65636
    [-25.50  -23.75] % 65637
    [-25.50  -23.75] % 65638
    [-25.50  -23.75] % 65639
    [-25.50  -23.75] % 65640
    [-25.50  -23.75] % 65641
    [-25.50  -23.75] % 65642
    [-25.50  -23.75] % 65643
    [-25.50  -23.75] % 65644
    [-25.50  -23.75] % 65645
    [-25.50  -23.75] % 65646
    [-25.50  -23.75] % 65647
    [-25.50  -23.75] % 65648
    [-25.50  -23.75] % 65649
    [-26.00  -23.00] % 65650
    [-25.50  -23.75] % 65651
    [-25.50  -23.75] % 65652
    [-25.50  -23.75] % 65653
    [-25.50  -23.75] % 65654
    [-25.50  -23.75] % 65655
    [-25.50  -23.75] % 65656
    [-25.50  -23.75] % 65657
    [-26.50  -24.25] % 65658
    [-25.50  -23.75] % 65659
    [-25.50  -23.75] % 65660
    [-25.50  -23.75] % 65661
    [-25.50  -23.75] % 65662
    [-25.50  -23.75] % 65663
    [-25.50  -23.50] % 65664
    [-26.50  -24.00] % 65665
    [-25.50  -23.75] % 65666
    [-26.50  -24.25] % 65667
    [-25.50  -23.75] % 65668
    [-25.50  -23.75] % 65669
    [-26.50  -24.00] % 65670
    [-25.50  -23.75] % 65671
    [-26.50  -23.50] % 65672
    [-25.50  -23.75] % 65673
    [-25.50  -23.75] % 65674
    [-25.50  -23.75] % 65675
    [-25.50  -23.75] % 65676
    [-25.50  -23.75] % 65677
    [-25.50  -23.75] % 65678
    [-25.50  -23.75] % 65679
    [-25.50  -23.75] % 65680
    [-25.50  -23.75] % 65681
    [-25.50  -23.75] % 65682
    [-25.50  -23.75] % 65683
    [-25.50  -23.75] % 65684
    [-25.50  -23.75] % 65685
    [-25.50  -23.75] % 65686
    [-25.50  -23.75] % 65687
    [-25.50  -23.75] % 65688
    [-25.50  -23.75] % 65689
    [-25.50  -23.75] % 65690
    [-25.50  -23.75] % 65691
    [-25.50  -23.75] % 65692
    [-25.50  -23.75] % 65693
    [-25.50  -23.75] % 65694
    [-25.50  -23.75] % 65695
    [-25.50  -23.75] % 65696
    [-25.50  -23.75] % 65697
    [-26.50  -24.25] % 65698
    [-25.50  -23.75] % 65699
    [-25.50  -23.75] % 65700
    [-25.50  -23.75] % 65701
    [-25.50  -23.75] % 65702
    [-25.50  -23.75] % 65703
    [-25.50  -23.75] % 65704
    [-27.00  -24.75] % 65705
    [-25.50  -23.75] % 65706
    [-25.50  -23.75] % 65707
    [-25.50  -23.75] % 65708
    [-26.50  -24.25] % 65709
    [-25.50  -23.75] % 65710
    [-25.50  -23.75] % 65711
    [-25.50  -23.75] % 65712
    [-25.50  -23.75] % 65713
    [-25.50  -23.75] % 65714
    [-26.75  -23.75] % 65715
    [-26.25  -23.75] % 65716
    [-25.50  -23.75] % 65717
    [-25.50  -23.75] % 65718
    [-25.50  -23.75] % 65719
    [-25.50  -23.75] % 65720
    [-25.50  -23.75] % 65721
    [-25.50  -23.75] % 65722
    [-25.50  -23.75] % 65723
    [-25.50  -23.75] % 65724
    [-25.50  -23.75] % 65725
    [-25.50  -23.75] % 65726
    [-25.50  -23.75] % 65727
    [-25.50  -23.75] % 65728
    [-25.50  -23.75] % 65729
    [-25.50  -23.75] % 65730
    [-25.50  -23.75] % 65731
    [-25.50  -23.75] % 65732
    [-25.50  -23.75] % 65733
    [-25.50  -23.75] % 65734
    [-25.50  -23.75] % 65735
    [-25.50  -23.75] % 65736
    [-25.50  -23.75] % 65737
    [-25.50  -23.75] % 65738
    [-25.50  -23.75] % 65739
    [-25.50  -23.75] % 65740
    [-25.50  -23.75] % 65741
    [-25.50  -23.75] % 65742
    [-25.50  -23.75] % 65743
    [-25.50  -23.75] % 65744
    [-25.25  -23.25] % 65745
    [-26.50  -24.00] % 65746
    [-25.50  -23.75] % 65747
    [-25.50  -23.75] % 65748
    [-25.50  -23.75] % 65749
    [-25.50  -23.75] % 65750
    [-25.50  -23.75] % 65751
    [-26.75  -24.25] % 65752
    [-26.50  -23.75] % 65753
    [-25.50  -23.75] % 65754
    [-25.50  -23.75] % 65755
    [-25.50  -23.75] % 65756
    [-25.50  -23.75] % 65757
    [-25.50  -23.75] % 65758
    [-26.75  -24.00] % 65759
    [-25.50  -23.75] % 65760
    [-26.50  -23.75] % 65761
    [-25.50  -23.75] % 65762
    [-25.50  -23.75] % 65763
    [-26.50  -23.50] % 65764
    [-26.50  -24.00] % 65765
    [-25.50  -23.75] % 65766
    [-25.50  -23.75] % 65767
    [-25.50  -23.75] % 65768
    [-25.50  -23.75] % 65769
    [-25.50  -23.75] % 65770
    [-25.50  -23.75] % 65771
    [-25.50  -23.75] % 65772
    [-25.50  -23.75] % 65773
    [-25.50  -23.75] % 65774
    [-25.50  -23.75] % 65775
    [-25.50  -23.75] % 65776
    [-25.50  -23.75] % 65777
    [-25.50  -23.75] % 65778
    [-25.50  -23.75] % 65779
    [-25.50  -23.75] % 65780
    [-25.50  -23.75] % 65781
    [-25.50  -23.75] % 65782
    [-25.50  -23.75] % 65783
    [-25.50  -23.75] % 65784
    [-25.50  -23.75] % 65785
    [-25.50  -23.75] % 65786
    [-26.25  -23.75] % 65787
    [-25.50  -23.75] % 65788
    [-25.50  -23.75] % 65789
    [-25.50  -23.75] % 65790
    [-25.50  -23.75] % 65791
    [-25.50  -23.75] % 65792
    [-25.50  -23.75] % 65793
    [-25.50  -23.75] % 65794
    [-25.50  -23.75] % 65795
    [-25.50  -23.75] % 65796
    [-25.50  -23.75] % 65797
    [-25.50  -23.75] % 65798
    [-25.50  -23.75] % 65799
    [-25.50  -23.75] % 65800
    [-25.50  -23.75] % 65801
    [-25.50  -23.75] % 65802
    [-25.50  -23.75] % 65803
    [-25.50  -23.75] % 65804
    [-25.50  -23.75] % 65805
    [-25.50  -23.75] % 65806
    [-26.75  -24.25] % 65807
    [-25.50  -23.75] % 65808
    [-26.50  -24.00] % 65809
    [-25.50  -23.75] % 65810
    [-26.50  -24.00] % 65811
    [-25.50  -23.75] % 65812
    [-25.50  -23.75] % 65813
    [-25.50  -23.75] % 65814
    [-26.50  -23.50] % 65815
    [-25.50  -23.75] % 65816
    [-25.50  -23.75] % 65817
    [-25.50  -23.75] % 65818
    [-25.50  -23.75] % 65819
    [-25.50  -23.75] % 65820
    [-25.50  -23.75] % 65821
    [-25.50  -23.75] % 65822
    [-25.50  -23.75] % 65823
    [-25.50  -23.75] % 65824
    [-25.50  -23.75] % 65825
    [-25.50  -23.75] % 65826
    [-25.50  -23.75] % 65827
    [-25.50  -23.75] % 65828
    [-25.50  -23.75] % 65829
    [-26.00  -24.00] % 65830
    [-25.50  -23.75] % 65831
    [-25.50  -23.75] % 65832
    [-25.50  -23.75] % 65833
    [-25.50  -23.75] % 65834
    [-25.50  -23.75] % 65835
    [-25.50  -23.75] % 65836
    [-25.50  -23.75] % 65837
    [-25.50  -23.75] % 65838
    [-25.50  -23.75] % 65839
    [-25.50  -23.75] % 65840
    [-25.50  -23.75] % 65841
    [-25.50  -23.75] % 65842
    [-25.50  -23.75] % 65843
    [-25.50  -23.75] % 65844
    [-26.75  -23.75] % 65845
    [-25.50  -23.75] % 65846
    [-25.50  -23.75] % 65847
    [-25.50  -23.75] % 65848
    [-25.50  -23.75] % 65849
    [-25.50  -23.75] % 65850
    [-27.20  -24.50] % 65851
    [-25.50  -23.75] % 65852
    [-25.50  -23.75] % 65853
    [-25.50  -23.75] % 65854
    [-25.50  -23.75] % 65855
    [-25.50  -23.75] % 65856
    [-25.50  -23.75] % 65857
    [-25.50  -23.75] % 65858
    [-25.50  -23.75] % 65859
    [-25.50  -23.75] % 65860
    [-25.50  -23.75] % 65861
    [-25.50  -23.75] % 65862
    [-25.50  -23.75] % 65863
    [-25.50  -23.75] % 65864
    [-25.50  -23.75] % 65865
    [-25.50  -23.75] % 65866
    [-25.50  -23.75] % 65867
    [-25.50  -23.75] % 65868
    [-25.50  -23.75] % 65869
    [-25.50  -23.75] % 65870
    [-25.50  -23.75] % 65871
    [-25.50  -23.75] % 65872
    [-25.50  -23.75] % 65873
    [-25.50  -23.75] % 65874
    [-25.50  -23.75] % 65875
    [-25.50  -23.75] % 65876
    [-25.50  -23.75] % 65877
    [-25.50  -23.75] % 65878
    [-25.50  -23.75] % 65879
    [-25.50  -23.75] % 65880
    [-25.50  -23.75] % 65881
    [-25.50  -23.75] % 65882
    [-25.50  -23.75] % 65883
    [-25.50  -23.75] % 65884
    [-25.50  -23.75] % 65885
    [-25.50  -23.75] % 65886
    [-25.50  -23.75] % 65887
    [-25.50  -23.75] % 65888
    [-25.50  -23.75] % 65889
    [-25.50  -23.75] % 65890
    [-25.50  -23.75] % 65891
    [-25.50  -23.75] % 65892
    [-25.50  -23.75] % 65893
    [-25.50  -23.75] % 65894
    [-25.50  -23.75] % 65895
    [-25.50  -23.75] % 65896
    [-25.50  -23.75] % 65897
    [-25.50  -23.75] % 65898
    [-25.50  -23.75] % 65899
    [-25.50  -23.75] % 65900
    [-25.50  -23.75] % 65901
    [-25.50  -23.75] % 65902
    [-25.50  -23.75] % 65903
    [-25.50  -23.75] % 65904
    [-25.50  -23.75] % 65905
    [-25.50  -23.75] % 65906
    [-25.50  -23.75] % 65907
    [-25.50  -23.75] % 65908
    [-25.50  -23.75] % 65909
    [-25.50  -23.75] % 65910
    [-25.50  -23.75] % 65911
    [-25.50  -23.75] % 65912
    [-25.50  -23.75] % 65913
    [-25.50  -23.75] % 65914
    [-25.50  -23.75] % 65915
    [-25.50  -23.75] % 65916
    [-25.50  -23.75] % 65917
    [-25.50  -23.75] % 65918
    [-25.50  -23.75] % 65919
    [-25.50  -23.75] % 65920
    [-25.50  -23.75] % 65921
    [-25.50  -23.75] % 65922
    [-25.50  -23.75] % 65923
    [-25.50  -23.75] % 65924
    [-25.50  -23.75] % 65925
    [-25.50  -23.75] % 65926
    [-25.50  -23.75] % 65927
    [-25.50  -23.75] % 65928
    [-25.50  -23.75] % 65929
    [-25.50  -23.75] % 65930
    [-25.50  -23.75] % 65931
    [-25.50  -23.75] % 65932
    [-25.50  -23.75] % 65933
    [-25.50  -23.75] % 65934
    [-25.50  -23.75] % 65935
    [-27.50  -24.00] % 65936
    [-25.50  -23.75] % 65937
    [-25.50  -23.75] % 65938
    [-25.50  -23.75] % 65939
    [-25.50  -23.75] % 65940
    [-25.50  -23.75] % 65941
    [-25.50  -23.75] % 65942
    [-25.50  -23.75] % 65943
    [-25.50  -23.75] % 65944
    [-25.50  -23.75] % 65945
    [-25.50  -23.75] % 65946
    [-25.50  -23.75] % 65947
    [-25.50  -23.75] % 65948
    [-25.50  -23.75] % 65949
    [-25.50  -23.75] % 65950
    [-25.50  -23.75] % 65951
    [-25.50  -23.75] % 65952
    [-25.50  -23.75] % 65953
    [-25.50  -23.75] % 65954
    [-25.50  -23.75] % 65955
    [-25.50  -23.75] % 65956
    [-25.50  -23.75] % 65957
    [-25.50  -23.75] % 65958
    [-25.50  -23.75] % 65959
    [-25.50  -23.75] % 65960
    [-25.50  -23.75] % 65961
    [-25.50  -23.75] % 65962
    [-25.50  -23.75] % 65963
    [-25.50  -23.75] % 65964
    [-25.50  -23.75] % 65965
    [-25.50  -23.75] % 65966
    [-25.50  -23.75] % 65967
    [-25.50  -23.75] % 65968
    [-25.50  -23.75] % 65969
    [-25.50  -23.75] % 65970
    [-25.50  -23.75] % 65971
    [-25.50  -23.75] % 65972
    [-25.50  -23.75] % 65973
    [-25.50  -23.75] % 65974
    [-25.50  -23.75] % 65975
    [-25.50  -23.75] % 65976
    [-25.50  -23.75] % 65977
    [-25.50  -23.75] % 65978
    [-25.50  -23.75] % 65979
    [-25.50  -23.75] % 65980
    [-25.50  -23.75] % 65981
    [-25.50  -23.75] % 65982
    [-25.50  -23.75] % 65983
    [-25.50  -23.75] % 65984
    [-25.50  -23.75] % 65985
    [-25.50  -23.75] % 65986
    [-25.50  -23.75] % 65987
    [-25.50  -23.75] % 65988
    [-25.50  -23.75] % 65989
    [-25.50  -23.75] % 65990
    [-25.50  -23.75] % 65991
    [-25.50  -23.75] % 65992
    [-25.50  -23.75] % 65993
    [-26.50  -23.50] % 65994
    [-25.50  -23.75] % 65995
    [-25.50  -23.75] % 65996
    [-25.50  -23.75] % 65997
    [-26.50  -24.25] % 65998
    [-25.50  -23.75] % 65999
    [-25.50  -23.75] % 66000
    [-25.50  -23.75] % 66001
    [-25.50  -23.75] % 66002
    [-26.50  -24.00] % 66003
    [-25.50  -23.75] % 66004
    [-25.50  -23.75] % 66005
    [-25.50  -23.75] % 66006
    [-25.50  -23.75] % 66007
    [-25.50  -23.75] % 66008
    [-25.50  -23.75] % 66009
    [-25.50  -23.75] % 66010
    [-25.50  -23.75] % 66011
    [-25.50  -23.75] % 66012
    [-25.50  -23.75] % 66013
    [-25.50  -23.75] % 66014
    [-25.50  -23.75] % 66015
    [-25.50  -23.75] % 66016
    [-25.50  -23.75] % 66017
    [-25.50  -23.75] % 66018
    [-25.50  -23.75] % 66019
    [-25.50  -23.75] % 66020
    [-25.50  -23.75] % 66021
    [-25.50  -23.75] % 66022
    [-25.50  -23.75] % 66023
    [-25.50  -23.75] % 66024
    [-26.25  -23.75] % 66025
    [-25.50  -23.75] % 66026
    [-25.50  -23.75] % 66027
    [-25.50  -23.75] % 66028
    [-25.50  -23.75] % 66029
    [-25.50  -23.75] % 66030
    [-25.50  -23.75] % 66031
    [-25.50  -23.75] % 66032
    [-25.50  -23.75] % 66033
    [-25.50  -23.75] % 66034
    [-26.25  -24.25] % 66035
    [-25.50  -23.75] % 66036
    [-25.50  -23.75] % 66037
    [-25.50  -23.75] % 66038
    [-25.50  -23.75] % 66039
    [-25.50  -23.75] % 66040
    [-25.50  -23.75] % 66041
    [-25.50  -23.75] % 66042
    [-25.50  -23.75] % 66043
    [-25.50  -23.75] % 66044
    [-25.50  -23.75] % 66045
    [-25.50  -23.75] % 66046
    [-25.50  -23.75] % 66047
    [-25.50  -23.75] % 66048
    [-25.50  -23.75] % 66049
    [-25.50  -23.75] % 66050
    [-26.50  -23.75] % 66051
    [-25.50  -23.25] % 66052
    [-25.50  -23.75] % 66053
    [-26.00  -23.75] % 66054
    [-26.50  -23.50] % 66055
    [-25.50  -23.75] % 66056
    [-25.50  -23.75] % 66057
    [-26.50  -23.75] % 66058
    [-26.50  -24.00] % 66059
    [-25.50  -23.75] % 66060
    [-25.50  -23.75] % 66061
    [-25.50  -23.75] % 66062
    [-26.50  -24.00] % 66063
    [-25.50  -23.75] % 66064
    [-25.50  -23.75] % 66065
    [-25.50  -23.75] % 66066
    [-25.50  -23.75] % 66067
    [-25.50  -23.75] % 66068
    [-25.50  -23.75] % 66069
    [-25.50  -23.75] % 66070
    [-25.50  -23.75] % 66071
    [-25.50  -23.75] % 66072
    [-25.50  -23.75] % 66073
    [-25.50  -23.75] % 66074
    [-26.00  -24.00] % 66075
    [-25.50  -23.75] % 66076
    [-25.50  -23.75] % 66077
    [-25.50  -23.75] % 66078
    [-25.50  -23.75] % 66079
    [-25.50  -23.75] % 66080
    [-25.50  -23.75] % 66081
    [-25.50  -23.75] % 66082
    [-25.50  -23.75] % 66083
    [-25.50  -23.75] % 66084
    [-25.50  -23.75] % 66085
    [-27.00  -24.25] % 66086
    [-25.50  -23.75] % 66087
    [-25.50  -23.75] % 66088
    [-25.50  -23.75] % 66089
    [-25.50  -23.75] % 66090
    [-25.50  -23.75] % 66091
    [-25.50  -23.75] % 66092
    [-25.50  -23.75] % 66093
    [-25.50  -23.75] % 66094
    [-25.50  -23.75] % 66095
    [-25.50  -23.75] % 66096
    [-25.50  -23.75] % 66097
    [-25.50  -23.75] % 66098
    [-26.00  -24.00] % 66099
    [-26.00  -24.00] % 66100
    [-25.50  -23.75] % 66101
    [-25.50  -23.75] % 66102
    [-25.50  -23.75] % 66103
    [-25.50  -23.75] % 66104
    [-25.50  -23.75] % 66105
    [-25.50  -23.75] % 66106
    [-25.50  -23.75] % 66107
    [-25.50  -23.75] % 66108
    [-25.50  -23.75] % 66109
    [-25.50  -23.75] % 66110
    [-25.50  -23.75] % 66111
    [-25.50  -23.75] % 66112
    [-25.50  -23.75] % 66113
    [-25.50  -23.75] % 66114
    [-25.50  -23.75] % 66115
    [-25.50  -23.75] % 66116
    [-25.50  -23.75] % 66117
    [-25.50  -23.75] % 66118
    [-25.50  -23.75] % 66119
    [-25.50  -23.75] % 66120
    [-25.50  -23.75] % 66121
    [-25.50  -23.75] % 66122
    [-25.50  -23.75] % 66123
    [-25.50  -23.75] % 66124
    [-25.50  -23.75] % 66125
    [-25.50  -23.75] % 66126
    [-25.50  -23.75] % 66127
    [-25.50  -23.75] % 66128
    [-25.50  -23.75] % 66129
    [-25.50  -23.75] % 66130
    [-25.50  -23.75] % 66131
    [-25.50  -23.75] % 66132
    [-25.50  -23.75] % 66133
    [-25.50  -23.75] % 66134
    [-25.50  -23.75] % 66135
    [-25.50  -23.75] % 66136
    [-25.50  -23.75] % 66137
    [-25.50  -23.75] % 66138
    [-25.50  -23.75] % 66139
    [-25.50  -23.75] % 66140
    [-25.50  -23.75] % 66141
    [-25.50  -23.75] % 66142
    [-25.50  -23.75] % 66143
    [-25.50  -23.75] % 66144
    [-25.50  -23.75] % 66145
    [-25.50  -23.75] % 66146
    [-25.50  -23.75] % 66147
    [-25.50  -23.75] % 66148
    [-25.50  -23.75] % 66149
    [-25.50  -23.75] % 66150
    [-25.50  -23.75] % 66151
    [-25.50  -23.75] % 66152
    [-25.50  -23.75] % 66153
    [-25.50  -23.75] % 66154
    [-25.50  -23.75] % 66155
    [-25.50  -23.75] % 66156
    [-25.50  -23.75] % 66157
    [-25.50  -23.75] % 66158
    [-25.50  -23.75] % 66159
    [-25.50  -23.75] % 66160
    [-25.50  -23.75] % 66161
    [-25.50  -23.75] % 66162
    [-25.50  -23.75] % 66163
    [-25.50  -23.75] % 66164
    [-25.50  -23.75] % 66165
    [-25.50  -23.75] % 66166
    [-25.50  -23.75] % 66167
    [-25.50  -23.75] % 66168
    [-25.50  -23.75] % 66169
    [-25.50  -23.75] % 66170
    [-25.50  -23.75] % 66171
    [-25.50  -23.75] % 66172
    [-25.50  -23.75] % 66173
    [-25.50  -23.75] % 66174
    [-25.50  -23.75] % 66175
    [-25.50  -23.75] % 66176
    [-25.50  -23.75] % 66177
    [-25.50  -23.75] % 66178
    [-25.50  -23.75] % 66179
    [-26.75  -24.50] % 66180
    [-25.50  -23.75] % 66181
    [-25.50  -23.75] % 66182
    [-26.50  -24.00] % 66183
    [-25.50  -23.75] % 66184
    [-25.50  -23.75] % 66185
    [-26.00  -24.00] % 66186
    [-25.50  -23.75] % 66187
    [-25.50  -23.75] % 66188
    [-25.50  -23.75] % 66189
    [-25.50  -23.75] % 66190
    [-25.50  -23.75] % 66191
    [-25.50  -23.75] % 66192
    [-26.25  -24.00] % 66193
    [-25.50  -23.75] % 66194
    [-25.50  -23.00] % 66195
    [-26.50  -23.75] % 66196
    [-26.00  -23.50] % 66197
    [-26.00  -23.75] % 66198
    [-26.00  -23.50] % 66199
    [-26.25  -24.00] % 66200
    [-26.50  -23.50] % 66201
    [-26.50  -23.50] % 66202
    [-26.00  -23.50] % 66203
    [-26.25  -24.25] % 66204
    [-25.50  -23.75] % 66205
    [-25.50  -23.75] % 66206
    [-25.50  -23.75] % 66207
    [-25.50  -23.75] % 66208
    [-25.50  -23.75] % 66209
    [-25.50  -23.75] % 66210
    [-26.50  -23.75] % 66211
    [-25.50  -23.75] % 66212
    [-26.25  -24.25] % 66213
    [-25.50  -23.75] % 66214
    [-25.50  -23.75] % 66215
    [-26.25  -24.25] % 66216
    [-25.50  -23.75] % 66217
    [-25.50  -23.75] % 66218
    [-25.50  -23.75] % 66219
    [-26.50  -24.25] % 66220
    [-27.00  -24.00] % 66221
    [-25.50  -23.75] % 66222
    [-25.50  -23.75] % 66223
    [-25.50  -23.75] % 66224
    [-25.50  -23.75] % 66225
    [-25.50  -23.75] % 66226
    [-25.50  -23.75] % 66227
    [-25.50  -23.75] % 66228
    [-25.50  -23.75] % 66229
    [-25.50  -23.75] % 66230
    [-25.50  -23.75] % 66231
    [-25.50  -23.75] % 66232
    [-25.50  -23.75] % 66233
    [-25.50  -23.75] % 66234
    [-25.50  -23.75] % 66235
    [-25.50  -23.75] % 66236
    [-25.50  -23.75] % 66237
    [-25.50  -23.75] % 66238
    [-25.50  -23.75] % 66239
    [-25.50  -23.75] % 66240
    [-25.50  -23.75] % 66241
    [-25.50  -23.75] % 66242
    [-25.50  -23.75] % 66243
    [-25.50  -23.75] % 66244
    [-25.50  -23.75] % 66245
    [-25.50  -23.75] % 66246
    [-25.50  -23.75] % 66247
    [-25.50  -23.75] % 66248
    [-25.50  -23.75] % 66249
    [-25.50  -23.75] % 66250
    [-25.50  -23.75] % 66251
    [-25.50  -23.75] % 66252
    [-25.50  -23.75] % 66253
    [-25.50  -23.75] % 66254
    [-25.50  -23.75] % 66255
    [-25.50  -23.75] % 66256
    [-25.50  -23.75] % 66257
    [-25.50  -23.75] % 66258
    [-25.50  -23.75] % 66259
    [-25.50  -23.75] % 66260
    [-25.50  -23.75] % 66261
    [-25.50  -23.75] % 66262
    [-25.50  -23.75] % 66263
    [-25.50  -23.75] % 66264
    [-25.50  -23.75] % 66265
    [-25.50  -23.75] % 66266
    [-25.50  -23.75] % 66267
    [-25.50  -23.75] % 66268
    [-25.50  -23.75] % 66269
    [-25.50  -23.75] % 66270
    [-25.50  -23.75] % 66271
    [-25.50  -23.75] % 66272
    [-25.50  -23.75] % 66273
    [-25.50  -23.75] % 66274
    [-25.50  -23.75] % 66275
    [-25.50  -23.75] % 66276
    [-25.50  -23.75] % 66277
    [-25.50  -23.75] % 66278
    [-25.50  -23.75] % 66279
    [-25.50  -23.75] % 66280
    [-25.50  -23.75] % 66281
    [-25.50  -23.75] % 66282
    [-25.50  -23.75] % 66283
    [-25.50  -23.75] % 66284
    [-25.50  -23.75] % 66285
    [-25.50  -23.75] % 66286
    [-25.50  -23.75] % 66287
    [-25.50  -23.75] % 66288
    [-25.50  -23.75] % 66289
    [-25.50  -23.75] % 66290
    [-25.50  -23.75] % 66291
    [-25.50  -23.75] % 66292
    [-25.50  -23.75] % 66293
    [-25.50  -23.75] % 66294
    [-25.50  -23.75] % 66295
    [-25.50  -23.75] % 66296
    [-25.50  -23.75] % 66297
    [-25.50  -23.75] % 66298
    [-25.50  -23.75] % 66299
    [-25.50  -23.75] % 66300
    [-25.50  -23.75] % 66301
    [-25.50  -23.75] % 66302
    [-25.50  -23.75] % 66303
    [-25.50  -23.75] % 66304
    [-25.50  -23.75] % 66305
    [-25.50  -23.75] % 66306
    [-25.50  -23.75] % 66307
    [-25.50  -23.75] % 66308
    [-25.50  -23.75] % 66309
    [-25.50  -23.75] % 66310
    [-25.50  -23.75] % 66311
    [-25.50  -23.75] % 66312
    [-25.50  -23.75] % 66313
    [-25.50  -23.75] % 66314
    [-25.50  -23.75] % 66315
    [-25.50  -23.75] % 66316
    [-25.50  -23.75] % 66317
    [-25.50  -23.75] % 66318
    [-25.50  -23.75] % 66319
    [-25.50  -23.75] % 66320
    [-25.50  -23.75] % 66321
    [-25.50  -23.75] % 66322
    [-25.50  -23.75] % 66323
    [-25.50  -23.75] % 66324
    [-25.50  -23.75] % 66325
    [-25.50  -23.75] % 66326
    [-25.50  -23.75] % 66327
    [-25.50  -23.75] % 66328
    [-25.50  -23.75] % 66329
    [-25.50  -23.75] % 66330
    [-25.50  -23.75] % 66331
    [-25.50  -23.75] % 66332
    [-25.50  -23.75] % 66333
    [-25.50  -23.75] % 66334
    [-25.50  -23.75] % 66335
    [-25.50  -23.75] % 66336
    [-25.50  -23.75] % 66337
    [-25.50  -23.75] % 66338
    [-25.50  -23.75] % 66339
    [-25.50  -23.75] % 66340
    [-25.50  -23.75] % 66341
    [-25.50  -23.75] % 66342
    [-25.50  -23.75] % 66343
    [-25.50  -23.75] % 66344
    [-25.50  -23.75] % 66345
    [-25.50  -23.75] % 66346
    [-25.50  -23.75] % 66347
    [-25.50  -23.75] % 66348
    [-25.50  -23.75] % 66349
    [-25.50  -23.75] % 66350
    [-25.50  -23.75] % 66351
    [-25.50  -23.75] % 66352
    [-25.50  -23.75] % 66353
    [-25.50  -23.75] % 66354
    [-25.50  -23.75] % 66355
    [-25.50  -23.75] % 66356
    [-25.50  -23.75] % 66357
    [-25.50  -23.75] % 66358
    [-25.50  -23.75] % 66359
    [-25.50  -23.75] % 66360
    [-25.50  -23.75] % 66361
    [-25.50  -23.75] % 66362
    [-25.50  -23.75] % 66363
    [-25.50  -23.75] % 66364
    [-25.50  -23.75] % 66365
    [-25.50  -23.75] % 66366
    [-25.50  -23.75] % 66367
    [-25.50  -23.75] % 66368
    [-25.50  -23.75] % 66369
    [-25.50  -23.75] % 66370
    [-25.50  -23.75] % 66371
    [-25.50  -23.75] % 66372
    [-25.50  -23.75] % 66373
    [-25.50  -23.75] % 66374
    [-25.50  -23.75] % 66375
    [-25.50  -23.75] % 66376
    [-25.50  -23.75] % 66377
    [-25.50  -23.75] % 66378
    [-25.50  -23.75] % 66379
    [-25.50  -23.75] % 66380
    [-25.50  -23.75] % 66381
    [-25.50  -23.75] % 66382
    [-25.50  -23.75] % 66383
    [-25.50  -23.75] % 66384
    [-25.50  -23.75] % 66385
    [-25.50  -23.75] % 66386
    [-25.50  -23.75] % 66387
    [-25.50  -23.75] % 66388
    [-25.50  -23.75] % 66389
    [-25.50  -23.75] % 66390
    [-25.50  -23.75] % 66391
    [-25.50  -23.75] % 66392
    [-25.50  -23.75] % 66393
    [-25.50  -23.75] % 66394
    [-25.50  -23.75] % 66395
    [-25.50  -23.75] % 66396
    [-25.50  -23.75] % 66397
    [-25.50  -23.75] % 66398
    [-25.50  -23.75] % 66399
    [-25.50  -23.75] % 66400
    [-25.50  -23.75] % 66401
    [-25.50  -23.75] % 66402
    [-25.50  -23.75] % 66403
    [-25.50  -23.75] % 66404
    [-25.50  -23.75] % 66405
    [-25.50  -23.75] % 66406
    [-25.50  -23.75] % 66407
    [-25.50  -23.75] % 66408
    [-25.50  -23.75] % 66409
    [-25.50  -23.75] % 66410
    [-25.50  -23.75] % 66411
    [-25.50  -23.75] % 66412
    [-25.50  -23.75] % 66413
    [-25.50  -23.75] % 66414
    [-25.50  -23.75] % 66415
    [-25.50  -23.75] % 66416
    [-25.50  -23.75] % 66417
    [-25.50  -23.75] % 66418
    [-25.50  -23.75] % 66419
    [-25.50  -23.75] % 66420
    [-25.50  -23.75] % 66421
    [-25.50  -23.75] % 66422
    [-25.50  -23.75] % 66423
    [-25.50  -23.75] % 66424
    [-25.50  -23.75] % 66425
    [-25.50  -23.75] % 66426
    [-25.50  -23.75] % 66427
    [-25.50  -23.75] % 66428
    [-25.50  -23.75] % 66429
    [-25.50  -23.75] % 66430
  };

  bounds = C{plateid-65537+1};
  minmag = bounds(1);
  maxmag = bounds(2);
end


function MM = genmm( cosmag, isky, x, y, ex, c )
  MM = [ ones(size(cosmag)) cosmag cosmag.^2 cosmag.^3 ...
         x y x.*y x.^2 y.^2 ...
         isky isky.^2 isky.^3 ...
         ex ...
         c ... 
       ];
end


function MM = genmm2( cosmag, isky, x, y, ex )
  MM = [ ones(size(cosmag)) cosmag cosmag.^2 cosmag.^3 ...
         x y x.*y x.^2 y.^2 ...
         isky isky.^2 isky.^3 ...
         ex ...
       ];
end


i = 0;
while ( ++i <= nargin )

  if ( strcmp(arg_list{i},'--help') )
    show_usage(stdout);
    exit(0);

  elseif ( strcmp(arg_list{i},'-o') )

    if ( ++i > nargin )
      fprintf(stderr,'missing output name after -o switch\n');
      show_usage(stderr);
      exit(0);
    end

    outname = arg_list{i}

  elseif ( strcmp(arg_list{i},'-K') )

    if ( ++i > nargin )
      fprintf(stderr,'missing K after -K switch\n');
      show_usage(stderr);
      exit(0);
    end

   [K, ok] = str2num(arg_list{i})
    if ( !ok )
      fprintf(stderr,'Syntax error: %s\n',arg_list{i});
      show_usage( stderr );
      exit(1);
    end


  elseif ( strcmp(arg_list{i},'-N') )

    if ( ++i > nargin )
      fprintf(stderr,'missing NPASS after -N switch\n');
      show_usage(stdout);
      exit(0);
    end

   [NPASS, ok] = str2num(arg_list{i})
   if ( !ok )
      fprintf(stderr,'Syntax error: %s\n',arg_list{i});
      show_usage( stderr );
      exit(1);
    end

  else
    FLIST{size(FLIST,2)+1} = arg_list{i};
  end

end


if ( size(FLIST,2) < 1 )
  show_usage(stderr);
  exit(1);
end


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


for i = 1:size(FLIST,2)

  v = [];
  fname = FLIST{i};


  [~, ~, ~, m] = regexp(fname,'\d+');
  [plateid,ok] = str2num(m{1});
  if ( !ok )
    fprintf(stderr,'can not get plateid from file name %s\n');
    continue;
  end

  % check if this plate is already processed
  if ( ~strcmp(outname,'') && exist(outname,'file') )
     status = system(sprintf('fgrep -q "^%d" %s', plateid, outname ));
     if ( status == 0 )
       printf('SKIP %s: ALREADY PROCESSES\n', fname);
       continue;
     end
  end


%  [minmag, maxmag] = get_cosmag_limits( plateid );


  % load Bj,Vj,scosmos
 
  printf('\n');
  printf('%s\n',fname);

  columns = 'Johnson_B,Johnson_V,cosmag,isky,ra,dec,objID,x,y,ex:(1.0-@bI/@aI)';

  cond = [ '@Johnson_B!=\"NA\" && @Johnson_V!=\"NA\" && ' ...
           '(@Johnson_B-@Johnson_V)>-0.75 && (@Johnson_B-@Johnson_V)<3.5 && ' ...
           '@Johnson_V>10 && @Johnson_B>10.5 &&' ...
	   'abs(@prfStat) < 5 && @class==2 && ' ...
	   '@aI>0 && @bI/@aI>0.5 && ' ...
           'abs(@B_err)<0.2 && abs(@Verr)<0.2 && ' ...
	   '@isky<6e7 && and(@quality,128)==0'
         ];


  cmd = sprintf('ccut %s -f "%s" -x "%s"', fname, columns, cond);

  pid = popen(cmd,'r');
  if ( pid == -1 ||  ~ischar(fgets(pid)) )
    fprintf(stderr,'can not read %s\n', fname);
  else
    v = transpose( fscanf(pid,'%lf',[10,Inf]) );
  end
  pclose(pid);

  if ( size(v,1) < 3 || size(v,2) != 10 )
    fprintf(stderr,'empty dataset %s\n', fname);
    continue;
  end


  % remove bad isky
  smin1 = min( v(:,4) ) + 1e6;
  smax1 = max( v(:,4) ) - 1e6;
  v = v(v(:,4) >= smin1 & v(:,4) <= smax1,:);


  % extract columns
  oBj    = v(:,1);
  oVj    = v(:,2);
  ocosmag= v(:,3);
  oisky  = v(:,4) * 1e-7;
  ora    = v(:,5);
  odec   = v(:,6);
  objID  = v(:,7);
  ox     = v(:,8)-177500;
  oy     = v(:,9)-177500;
  oex    = v(:,10);

  % select cosmag range 
  good   = ocosmag < -23.00 & ocosmag > -27.00;
  Bj     = oBj(good);
  Vj     = oVj(good);
  cosmag = ocosmag(good);
  isky   = oisky(good);
  x      = ox(good);
  y      = oy(good);
  ex     = oex(good);
  RA     = mean(ora) * 180/pi;
  DE     = mean(odec) * 180/pi;


  % Make regression
  %  Bj = P1(scosmos) + P2(isky) + P3(x,y) + C*(Bj-Vj)
  %
  % The Bc will defined as:
  %  Bc = P1(scosmos) + P2(isky) + P3(x,y)

  for pass = 1:NPASS

    MM = genmm(cosmag, isky, x, y, ex, (Bj-Vj));

    [A, sigma] = LinearRegression(MM, Bj);
    sigma = sqrt(sigma);

    printf('* %d sigma=%g rows=%d\n', pass, sigma, rows(MM));
    for i = 1:size(A,1)
      printf('A%d = %+g\n',i,A(i));
    end

    if ( K == 0 || pass == NPASS || all(good=abs(Bj-MM*A)<K*sigma) )
      break;
    end

    Bj = Bj(good);
    Vj = Vj(good);
    cosmag = cosmag(good);
    isky = isky(good);
    x = x(good);
    y = y(good);
    ex = ex(good);
  end

  if ( ~strcmp(outname,'') )

    % save regression coefficients
    if ( ~exist(outname,'file') )
      fid = fopen(outname,'w');
      if ( fid == -1 )
        fprintf(stderr,'can not write %s\n', outname);
        exit (1);
      end
      
      fprintf(fid,'pid\tRA\tDEC\tN\tS');
      for i = 1:size(A,1)
	fprintf(fid,'\tA%d',i);
      end
      fprintf(fid,'\n');
      fclose(fid);
    end


    fid = fopen(outname,'a');
    if ( fid == -1 )
      fprintf(stderr,'can not write %s\n', outname);
      exit (1);
    end

    fprintf( fid, '%d\t%7.3f\t%+8.3f\t%d\t%.3f', 
        plateid, RA, DE, rows(cosmag), sigma );
    for i = 1:size(A)
     fprintf(fid,'\t%+.6E',A(i));
    end
    fprintf(fid,'\n');
    fclose(fid);

  end

  fname = sprintf('%s.res',fname);
  fid = fopen(fname,'w');
  fprintf(fid,'objID\tex\tx\ty\tra\tdec\tBj\tVj\tcosmag\tisky\tBc\tdM\n');
  
  MM = genmm2(ocosmag, oisky, ox, oy, oex ); 
  AA = A([1:(size(A,1)-1)]);
  Bc = MM * AA;
  dM = oBj - A(size(A,1))*(oBj-oVj) - Bc;

  fprintf(fid,'%.0f\t%.3f\t%.3f\t%.3f\t%.9f\t%+.9f\t%.3f\t%.3f\t%.3f\t%.3f\t%.3f\t%+.3f\n',
    transpose([objID oex ox oy ora*180/pi odec*180/pi oBj oVj ocosmag oisky Bc dM]));

  fclose (fid);

end

